#
# Copyright (C) 2017 ZeXtras S.r.l.
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation, version 2 of
# the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License.
# If not, see <http://www.gnu.org/licenses/>.
#

DOCUMENT_DRAFT?=true

all: dist/admin-guide.pdf

.PHONY: clean

build/variables.tex:
	mkdir -p build
	echo "% Auto-generated by makefile, do not edit!" >> build/variables.tex
	echo "\\\newcommand{\\\branchName}{$(shell git rev-parse --abbrev-ref HEAD)}" >> build/variables.tex
	echo "\\\newcommand{\\\version}{$(shell git rev-parse --abbrev-ref HEAD | cut -d '/' -f2)}" >> build/variables.tex
	echo "\\\newcommand{\\\commitId}{$(shell git rev-parse HEAD)}" >> build/variables.tex
	echo "\\\newcommand{\\\shortCommitId}{$(shell git rev-parse --short HEAD)}" >> build/variables.tex
ifeq ("true", "$(DOCUMENT_DRAFT)")
	echo "\\\newcommand{\\\ISDRAFT}{}" >> build/variables.tex
endif

build/admin-guide.pdf: build/variables.tex
	mkdir -p build
	pdflatex -output-directory=build admin-guide.tex
	pdflatex -output-directory=build admin-guide.tex

build/html: build/variables.tex
	mkdir -p build/html
	htlatex admin-guide.tex
	rm excuses.txt
	mv admin-guide.4ct build/html
	mv admin-guide.4tc build/html
	mv admin-guide.aux build/html
	mv admin-guide.css build/html
	mv admin-guide.dvi build/html
	mv admin-guide.html build/html
	mv admin-guide.idv build/html
	mv admin-guide.lg build/html
	mv admin-guide.log build/html
	mv admin-guide.tmp build/html
	mv admin-guide.xref build/html

dist/admin-guide.pdf: build/admin-guide.pdf
	mkdir -p dist
	cp build/admin-guide.pdf dist/admin-guide.pdf

build/admin-guide.adoc: build/variables.tex
	mkdir -p build
	pandoc -f latex -t asciidoc admin-guide.tex -o build/admin-guide.adoc

dist/asciidoc/admin-guide.adoc: build/admin-guide.adoc
	mkdir -p dist/asciidoc
	cp build/admin-guide.adoc dist/asciidoc/admin-guide.adoc
	sed -i \
		-e 's/\[\[==/\[\[/g' \
		-e 's/==\]\]/\]\]/g' \
		-e 's/\[==/<</g' \
		-e 's/==\]/>>/g' \
		-e ':a;N;$$!ba;s/TIP:\n\n/TIP\: /g' \
		-e ':a;N;$$!ba;s/WARNING:\n\n/WARNING\: /g' \
		dist/asciidoc/admin-guide.adoc
	mkdir -p dist/asciidoc/template
	cp template/cc-by-nc-sa.png dist/asciidoc/template

#build/user-guide.pdf:
#	mkdir -p build
#	pdflatex -output-directory=build user-guide.tex
#	pdflatex -output-directory=build user-guide.tex

#dist/user-guide.pdf: build/user-guide.pdf
#	mkdir -p dist
#	cp build/user-guide.pdf dist/user-guide.pdf

clean:
	rm -f -r \
		build/variables.tex \
		build/admin-guide.adoc \
		build/admin-guide.aux \
		build/admin-guide.log \
		build/admin-guide.out \
		build/admin-guide.pdf \
		build/admin-guide.ptc \
		build/admin-guide.toc \
		dist/admin-guide.pdf \
		build/user-guide.aux \
		build/user-guide.log \
		build/user-guide.out \
		build/user-guide.pdf \
		build/user-guide.ptc \
		build/user-guide.toc \
		dist/user-guide.pdf \
		build/excuses.txt \
		excuses.txt\
		build/html\
		dist/asciidoc
